Backport of:

From cde460582ff389404b5b3ccb59374e9b389de916 Mon Sep 17 00:00:00 2001
From: Michiel Rook <mrook@php.net>
Date: Mon, 14 Dec 2020 14:15:41 +0100
Subject: [PATCH] Disallow symlinks to out-of-path filenames

---
 Archive/Tar.php               |   8 ++++++++
 tests/out_of_path_fnames.phpt |  18 ++++++++++++++++++
 tests/out_of_path_symlink.tar | Bin 0 -> 2561 bytes
 3 files changed, 26 insertions(+)
 create mode 100644 tests/out_of_path_fnames.phpt
 create mode 100644 tests/out_of_path_symlink.tar

--- a/submodules/Archive_Tar/Archive/Tar.php
+++ b/submodules/Archive_Tar/Archive/Tar.php
@@ -2099,6 +2099,14 @@ class Archive_Tar extends PEAR
                             }
                         }
                     } elseif ($v_header['typeflag'] == "2") {
+                        if (strpos(realpath(dirname($v_header['link'])), realpath($p_path)) !== 0) {
+                            $this->_error(
+                                 'Out-of-path file extraction {'
+                                 . $v_header['filename'] . ' --> ' .
+                                 $v_header['link'] . '}'
+                            );
+                            return false;
+                        }
                         if (@file_exists($v_header['filename'])) {
                             @unlink($v_header['filename']);
                         }
